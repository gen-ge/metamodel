name: ğŸ§ª Context Navigator CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    name: ğŸ§ª Test on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.7, 3.8, 3.9, "3.10", "3.11"]

    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v3

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ”§ Setup Development Environment
        run: |
          chmod +x cndev.sh
          echo "âœ… Development environment setup"

      - name: ğŸ§ª Test Development Commands
        run: |
          ./cndev.sh version
          ./cndev.sh help

      - name: ğŸ—ï¸ Test Build System
        run: |
          python3 build.py --version ci-test-${{ github.sha }}
          echo "âœ… Build successful"

      - name: ğŸ“¦ Validate Build Package
        run: |
          cd dist
          tar -tzf context-navigator-ci-test-${{ github.sha }}.tar.gz | head -10
          echo "âœ… Package contents validated"

  # Job para testar instalaÃ§Ã£o
  install-test:
    name: ğŸš€ Installation Test
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: ğŸ—ï¸ Build Package
        run: |
          python3 build.py --version ci-install-test

      - name: ğŸš€ Test Installation
        run: |
          cd dist
          tar -xzf context-navigator-ci-install-test.tar.gz
          cd context-navigator-ci-install-test
          python3 install.py
          echo "âœ… Installation successful"

  # Job para release automÃ¡tico (quando houver tags)
  release:
    name: ğŸš€ Auto Release
    runs-on: ubuntu-latest
    needs: [test, install-test]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: ğŸ—ï¸ Build Release Package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          python3 build.py --version $VERSION
          echo "âœ… Release package built: $VERSION"

      - name: ğŸ“¤ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/context-navigator-*.tar.gz
            dist/context-navigator-*.zip
            dist/install-context-navigator-*.txt
            dist/install-context-navigator-*.sh
          name: Context Navigator v${{ github.ref_name }}
          body: |
            ğŸ§­ **Context Navigator v${{ github.ref_name }}**

            ## ğŸš€ InstalaÃ§Ã£o RÃ¡pida
            ```bash
            curl -L https://github.com/gen-ge/metamodel/releases/download/${{ github.ref_name }}/install-context-navigator-latest.sh | bash
            ```

            ## ğŸ“¦ Arquivos DisponÃ­veis
            - `context-navigator-*.tar.gz` - Pacote principal
            - `context-navigator-*.zip` - Pacote ZIP
            - `install-context-navigator-*.sh` - Instalador shell
            - `install-context-navigator-*.txt` - Instalador Python

            Ver **[RELEASE_NOTES.md](RELEASE_NOTES.md)** para detalhes completos.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job para lint (futuro)
  lint:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: ğŸ” Basic Code Validation
        run: |
          # Verificar syntax bÃ¡sica dos arquivos Python
          python3 -m py_compile src/context_navigator/core/*.py
          python3 -m py_compile src/context_navigator/scripts/*/*.py
          echo "âœ… Python syntax validation passed"

      - name: ğŸ“š Documentation Check
        run: |
          # Verificar se arquivos de documentaÃ§Ã£o existem
          test -f README.md
          test -f CONTRIBUTING.md
          test -f docs/c1-systems/MANUAL_HUMANO.md
          echo "âœ… Documentation files present"
